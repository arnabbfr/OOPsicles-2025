<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Authority Portal</title>
    <link rel="stylesheet" href="authority-styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> LokLink - Government Authority Portal</h1>
            <p>Manage and resolve citizen-reported issues efficiently</p>
        </div>

        <!-- Statistics Dashboard -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number total" id="totalIssues">0</div>
                <div class="stat-label">Total Issues</div>
            </div>
            <div class="stat-card">
                <div class="stat-number pending" id="pendingIssues">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number in-progress" id="progressIssues">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-number resolved" id="resolvedIssues">0</div>
                <div class="stat-label">Resolved</div>
            </div>
            <div class="stat-card">
                <button class="btn btn-danger" onclick="clearResolved()"> Clear Resolved</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Issues Management Section -->
            <div class="issues-management">
                <h2 class="section-title"> Issues Management</h2>
                
                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="statusFilter" onchange="filterIssues()">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Type:</label>
                        <select id="typeFilter" onchange="filterIssues()">
                            <option value="all">All Types</option>
                            <option value="road-repair">Road Repair</option>
                            <option value="streetlight">Street Light</option>
                            <option value="water-supply">Water Supply</option>
                            <option value="garbage">Garbage Collection</option>
                            <option value="drainage">Drainage</option>
                            <option value="traffic">Traffic Management</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Priority:</label>
                        <select id="priorityFilter" onchange="filterIssues()">
                            <option value="all">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="searchFilter" placeholder="Search issues..." oninput="filterIssues()">
                    </div>
                </div>

                <!-- Issues List -->
                <div id="issuesList">
                    <!-- Issues will be populated here by JavaScript -->
                </div>
            </div>

            <!-- Department Assignment Panel -->
            <div class="assignment-panel">
                <h2 class="section-title"> Department Management</h2>
                
                <div class="departments-list" id="departmentsList">
                    <!-- Departments will be populated here -->
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="map-section">
            <h2 class="section-title"> City Issues Overview</h2>
            
            <div class="map-container" id="mapContainer">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>Pending Issues</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color yellow"></div>
                    <span>In Progress</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color green"></div>
                    <span>Resolved Issues</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Details Modal -->
    <div id="issueModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                <!-- Issue details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = location.origin.replace(/\/$/, '') + '/api';

        // Data stores
        let issues = [];
        let departments = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            renderIssues();
            renderDepartments();
            updateStats();
            if (window.google && window.google.maps) {
                initializeMap();
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        });

        async function loadData() {
            try {
                const [issuesRes, deptsRes] = await Promise.all([
                    fetch(`${API_BASE}/issues`),
                    fetch(`${API_BASE}/departments`)
                ]);
                issues = await issuesRes.json();
                departments = await deptsRes.json();
            } catch (e) {
                issues = issues || [];
                departments = departments || [];
            }
        }

        function renderIssues(filteredIssues = issues) {
            const issuesContainer = document.getElementById('issuesList');
            issuesContainer.innerHTML = '';

            if (!filteredIssues || filteredIssues.length === 0) {
                issuesContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No issues found matching the current filters.</p>';
                return;
            }

            filteredIssues.forEach(issue => {
                const issueCard = createIssueCard(issue);
                issuesContainer.appendChild(issueCard);
            });
        }
        
        function createIssueCard(issue) {
            const card = document.createElement('div');
            card.className = `issue-card priority-${issue.priority}`;
            const statusClass = `status-${issue.status}`;
            const typeDisplay = (issue.type || '').replace('-', ' ').toUpperCase();
            
            card.innerHTML = `
                <div class="issue-header">
                    <div>
                        <span class="issue-id">${issue.id}</span>
                        <span class="issue-type">${typeDisplay}</span>
                    </div>
                    <span class="issue-status ${statusClass}">${issue.status.replace('-', ' ')}</span>
                </div>
                
                <div class="issue-details">
                    <div class="issue-description">
                        <strong>${issue.title || ''}</strong><br>
                        ${issue.description || ''}
                    </div>
                    
                    <div class="issue-meta">
                        <span> ${issue.location || ''}</span>
                        <span> ${issue.reportedAt || ''}</span>
                        <span> ${issue.reportedBy || ''}</span>
                        <span> Priority: ${(issue.priority || '').toUpperCase()}</span>
                    </div>
                    
                    ${issue.assignedTo ? `
                        <div class="issue-meta">
                            <span> Assigned to: ${issue.assignedTo}</span>
                            <span> ${issue.assignedAt || ''}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="issue-actions">
                    <button class="btn btn-primary" onclick="viewIssueDetails('${issue.id}')">
                         View Details
                    </button>
                    
                    ${issue.status === 'pending' ? `
                        <button class="btn btn-warning" onclick="assignIssue('${issue.id}')">
                             Assign Department
                        </button>
                    ` : ''}
                    
                    ${issue.status === 'in-progress' ? `
                        <button class="btn btn-success" onclick="updateStatus('${issue.id}', 'resolved')">
                             Mark Resolved
                        </button>
                    ` : ''}
                    
                    <button class="btn btn-primary" onclick="addUpdate('${issue.id}')">
                         Add Update
                    </button>
                    
                    ${issue.status !== 'resolved' ? `
                        <button class="btn btn-warning" onclick="changePriority('${issue.id}')">
                             Change Priority
                        </button>
                    ` : ''}
                </div>
                
                <div class="assignment-form" id="assignForm-${issue.id}">
                    <h4>Assign to Department</h4>
                    <div class="form-group">
                        <label>Department:</label>
                        <select id="dept-${issue.id}">
                            <option value="">Select Department</option>
                            ${departments.map(dept => 
                                `<option value="${dept.id}">${dept.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority:</label>
                        <select id="priority-${issue.id}">
                            <option value="low" ${issue.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${issue.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${issue.priority === 'high' ? 'selected' : ''}>High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Instructions:</label>
                        <textarea id="instructions-${issue.id}" placeholder="Special instructions for the department..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="confirmAssignment('${issue.id}')">Confirm Assignment</button>
                    <button class="btn btn-danger" onclick="cancelAssignment('${issue.id}')">Cancel</button>
                </div>
            `;
            return card;
        }

        function renderDepartments() {
            const container = document.getElementById('departmentsList');
            if (!container) return;
            container.innerHTML = '';
            const deptIdToIssues = issues.reduce((acc, iss) => {
                if (iss.department) {
                    acc[iss.department] = acc[iss.department] || [];
                    acc[iss.department].push(iss);
                }
                return acc;
            }, {});
            departments.forEach(dept => {
                const assigned = deptIdToIssues[dept.id] || [];
                const div = document.createElement('div');
                div.className = 'department-card';
                div.innerHTML = `
                    <div class="department-header">
                        <strong>${dept.name}</strong>
                        <span>${assigned.length} assigned</span>
                    </div>
                    <div class="department-body">
                        <div>Contact: ${dept.contact || ''}</div>
                        <div style="margin-top:8px">
                            ${assigned.length ? assigned.map(i => `<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;padding:6px 8px;border:1px solid #eee;border-radius:6px">
                                <span>${i.id} • ${(i.title || i.type || '').toString().slice(0,40)}</span>
                                ${i.status !== 'resolved' ? `<button class="btn btn-success" onclick="updateStatus('${i.id}','resolved')">Resolve</button>` : '<span style="color:#27ae60;font-weight:600">Resolved</span>'}
                            </div>`).join('') : '<em>No assignments</em>'}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStats() {
            const total = issues.length;
            const pending = issues.filter(i => i.status === 'pending').length;
            const inProgress = issues.filter(i => i.status === 'in-progress').length;
            const resolved = issues.filter(i => i.status === 'resolved').length;
            const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            setText('totalIssues', total);
            setText('pendingIssues', pending);
            setText('progressIssues', inProgress);
            setText('resolvedIssues', resolved);
        }

        function findIssueById(issueId) { return issues.find(i => i.id === issueId); }

        function viewIssueDetails(issueId) {
            const issue = findIssueById(issueId);
            if (!issue) return;
            const modal = document.getElementById('issueModal');
            const content = document.getElementById('modalContent');
            if (!modal || !content) return;
            const mediaHtml = (issue.media && issue.media.length)
                ? `<div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">${issue.media.map(u => `<a href="${u}" target="_blank"><img src="${u}" alt="evidence" style="width:90px;height:70px;object-fit:cover;border-radius:6px;border:1px solid #eee"/></a>`).join('')}</div>`
                : '<em>No media</em>';
            content.innerHTML = `
                <h3>${issue.title || ''} (${issue.id})</h3>
                <p>${issue.description || ''}</p>
                <p><strong>Location:</strong> ${issue.location || ''}</p>
                <p><strong>Status:</strong> ${issue.status}</p>
                <p><strong>Priority:</strong> ${issue.priority}</p>
                <div><strong>Evidence:</strong> ${mediaHtml}</div>
                <div style="margin-top:10px">${(issue.updates || []).map(u => `<div>• ${u.date}: ${u.note}</div>`).join('') || '<em>No updates</em>'}</div>
            `;
            modal.style.display = 'block';
        }

        function closeModal() { const m = document.getElementById('issueModal'); if (m) m.style.display = 'none'; }

        function assignIssue(issueId) { const f = document.getElementById(`assignForm-${issueId}`); if (f) f.style.display = 'block'; }
        function cancelAssignment(issueId) { const f = document.getElementById(`assignForm-${issueId}`); if (f) f.style.display = 'none'; }

        async function confirmAssignment(issueId) {
            const issue = findIssueById(issueId);
            if (!issue) return;
            const deptSelect = document.getElementById(`dept-${issueId}`);
            const prioritySelect = document.getElementById(`priority-${issueId}`);
            const instructionsInput = document.getElementById(`instructions-${issueId}`);
            if (!deptSelect || !prioritySelect) return;
            const dept = departments.find(d => d.id === deptSelect.value);
            try {
                const res = await fetch(`${API_BASE}/issues/${issueId}/assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        department: dept ? dept.id : null,
                        assignedTo: dept ? dept.name : null,
                        priority: prioritySelect.value,
                        instructions: instructionsInput && instructionsInput.value ? instructionsInput.value.trim() : ''
                    })
                });
                if (!res.ok) throw new Error('Failed to assign');
                const updated = await res.json();
                const idx = issues.findIndex(i => i.id === updated.id);
                if (idx >= 0) issues[idx] = updated; else issues.push(updated);
                cancelAssignment(issueId);
                renderIssues(filterIssuesReturnCurrent());
                updateStats();
                if (mapInstance) renderMapMarkers(filterIssuesReturnCurrent());
            } catch (e) {
                alert('Assignment failed.');
            }
        }

        async function updateStatus(issueId, newStatus) {
            try {
                const res = await fetch(`${API_BASE}/issues/${issueId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!res.ok) throw new Error('Failed');
                const updated = await res.json();
                const idx = issues.findIndex(i => i.id === updated.id);
                if (idx >= 0) issues[idx] = updated; else issues.push(updated);
                renderIssues(filterIssuesReturnCurrent());
                updateStats();
                renderDepartments();
                if (mapInstance) renderMapMarkers(filterIssuesReturnCurrent());
            } catch (e) {
                alert('Status update failed.');
            }
        }

        async function clearResolved() {
            if (!confirm('Archive and remove all resolved issues?')) return;
            try {
                const res = await fetch(`${API_BASE}/issues/clear-resolved`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                if (!res.ok) throw new Error('Failed to clear');
                await loadData();
                renderIssues(filterIssuesReturnCurrent());
                updateStats();
                renderDepartments();
                if (mapInstance) renderMapMarkers(filterIssuesReturnCurrent());
            } catch (e) {
                alert('Failed to clear resolved issues.');
            }
        }

        function addUpdate(issueId) {
            const note = prompt('Enter update note');
            if (!note || !note.trim()) return;
            const issue = findIssueById(issueId);
            if (!issue) return;
            issue.updates = issue.updates || [];
            issue.updates.push({ date: new Date().toLocaleString(), note: note.trim(), by: 'Operator' });
            renderIssues(filterIssuesReturnCurrent());
        }

        function changePriority(issueId) {
            const issue = findIssueById(issueId);
            if (!issue) return;
            const next = { low: 'medium', medium: 'high', high: 'low' };
            issue.priority = next[issue.priority] || 'medium';
            renderIssues(filterIssuesReturnCurrent());
        }

        function filterIssuesReturnCurrent() {
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            const search = document.getElementById('searchFilter').value.trim().toLowerCase();
            return issues.filter(issue => {
                const matchesStatus = status === 'all' || issue.status === status;
                const matchesType = type === 'all' || issue.type === type;
                const matchesPriority = priority === 'all' || issue.priority === priority;
                const matchesSearch = !search ||
                    (issue.title || '').toLowerCase().includes(search) ||
                    (issue.description || '').toLowerCase().includes(search) ||
                    (issue.location || '').toLowerCase().includes(search) ||
                    (issue.id || '').toLowerCase().includes(search);
                return matchesStatus && matchesType && matchesPriority && matchesSearch;
            });
        }

        function filterIssues() {
            const filtered = filterIssuesReturnCurrent();
            renderIssues(filtered);
            if (mapInstance) renderMapMarkers(filtered);
        }

        // -------------------- MAP INTEGRATION --------------------
        let mapInstance = null;
        let mapMarkers = [];

        function initializeMap() {
            const mapElement = document.getElementById('map');
            if (!mapElement) return;
            const defaultCenter = { lat: 26.7282, lng: 94.2042 };
            mapInstance = new google.maps.Map(mapElement, {
                center: defaultCenter,
                zoom: 14,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true
            });
            renderMapMarkers();
        }

        function getStatusColor(status) {
            switch (status) {
                case 'pending': return '#e74c3c';
                case 'in-progress': return '#f2a516';
                case 'resolved': return '#27ae60';
                default: return '#3498db';
            }
        }

        function createSvgPin(color) {
            return {
                path: 'M12 2C7.582 2 4 5.582 4 10c0 5.25 8 12 8 12s8-6.75 8-12c0-4.418-3.582-8-8-8zm0 10.5A2.5 2.5 0 1 1 12 7.5a2.5 2.5 0 0 1 0 5z',
                fillColor: color,
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2,
                scale: 1.2,
                anchor: new google.maps.Point(12, 22)
            };
        }

        function clearMapMarkers() { mapMarkers.forEach(m => m.setMap(null)); mapMarkers = []; }

        function renderMapMarkers(filteredIssues = null) {
            if (!mapInstance) return;
            const data = filteredIssues || issues;
            clearMapMarkers();
            const infoWindow = new google.maps.InfoWindow();
            data.forEach(item => {
                if (!item.coordinates) return;
                const position = { lat: item.coordinates.lat, lng: item.coordinates.lng };
                const marker = new google.maps.Marker({
                    position,
                    map: mapInstance,
                    icon: createSvgPin(getStatusColor(item.status)),
                    title: `${item.id} - ${item.title}`
                });
                marker.addListener('click', () => {
                    const content = `
                        <div style="max-width:260px">
                            <div style="font-weight:600;margin-bottom:4px">${item.title || ''}</div>
                            <div style="font-size:12px;color:#555;margin-bottom:6px">${item.location || ''}</div>
                            <div style="font-size:12px;margin-bottom:6px">Status: <span style="font-weight:600;text-transform:capitalize">${(item.status || '').replace('-', ' ')}</span></div>
                            <button onclick="viewIssueDetails('${item.id}')" style="padding:6px 10px;border:none;background:#2c3e50;color:#fff;border-radius:4px;cursor:pointer">View Details</button>
                        </div>`;
                    infoWindow.setContent(content);
                    infoWindow.open({ map: mapInstance, anchor: marker });
                });
                mapMarkers.push(marker);
            });
            if (mapMarkers.length) {
                const bounds = new google.maps.LatLngBounds();
                mapMarkers.forEach(m => bounds.extend(m.getPosition()));
                mapInstance.fitBounds(bounds);
            }
        }
    </script>
    <!-- Load Google Maps JS API (replace YOUR_API_KEY with a valid key) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCic2nOSqta56xC_M4nIYodcjSDgAAT4JY&callback=initializeMap"></script>
</body>
</html>